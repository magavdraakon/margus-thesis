

\chapter{Protecting Web Application Against (D)DOS Attacks}
\label{Protecting Web Application Against (D)DOS Attacks}

 
\begin{quote}
"If you tell me, I will listen. If you show me, I
will see. If you let me experience, I will learn." --- Lao Tzu (6th Century BC)
\end{quote}

\section{Introduction}
This goal of this lab secure web application -- WordPress against (D)DOS attacks to the level where main limitation becomes a network throughput. Configured server must recover after attacks are ended.

Web application WordPress are used because misbehave of the default installation which can not take reasonable load.

\section{Pre-Requirements}
Prelimary course topics~\ref{Preliminary course - dpkg based GNU/Linux} and completed the preliminary test~\ref{Preliminary Tests} (theory and practice)
Knowledge about \gls{HTTP} (different request types, virtual hosts, status codes), \gls{IP} and aliases, \gls{UDP}

In case of need for refresh the basic those materials are suitable for rehearsal the basics of the \gls{HTTP}~\footnote{
\href{http://net.tutsplus.com/tutorials/tools-and-tips/http-the-protocol-every-web-developer-must-know-part-1/}{net.tutsplus.com - tools and tips - HTTP part 1}} \footnote{
\href{http://net.tutsplus.com/tutorials/tools-and-tips/http-the-protocol-every-web-developer-must-know-part-2/}{net.tutsplus.com - tools and tips - HTTP part 1}}
\section{Scope}
Software used:  GNU/Linux distribution Ubuntu Server 12.04 LTS 64bit, WordPress -- latest version available, MySQL from Ubuntu repositories, Apache2 web server from repositories, GNU/Linux Ubuntu Client 12.04 LTS 64bit for performing load generation with apache2 utils.

\section{Learning Objectives}
Student installs and configures the apache2 web server and WordPress web application with \gls{MySQL} database.
Student is able to use caching technologies to protect web application against simpler DOS attacks. Student configures web service and demonstrates that can be
easily take offline using simple load generator. Minimal level: Student configures
proper caching and demonstrates that web application survives same attack.
\section{Setting up the Virtual Environment - VirtualBox sample}
In this lab we use two Ubuntu Linux virtual machines.
Ubuntu server 512MB RAM, NIC1 - NAT, NIC2 - HostOnly with address 192.168.56.200
Ubuntu client 1GB RAM NIC1 - NAT, NIC2 - HostOnly wid dynamic address. (probably 192.168.56.101)
Download virtual machines to the local disk
\url{http://elab.itcollege.ee:8000/infra_klient_small.ova}
\url{http://elab.itcollege.ee:8000/infra_server.ova}

Import virtual machines (If your host computer has only 4GB RAM, then reduce client machine memory to 1GB)

Start both machines. 

{\small{If you got an error about host only network then open Main Menu, choose File Preferences and choose Network and add Host Only Network.}}

Username and password for both machines are student, student.

Username: student
Password: student
Student user are in sudo group and can start administrator shell with sudo command.

Log on to client and add two addresses on /etc/hosts
\begin{minted}[frame=lines,framesep=2mm]{bash}
echo "192.168.56.200 wp.planet.zz">>/etc/hosts
\end{minted}

\section{Installation of the WordPress}
All following commands must executed as root user. To get root permissions in Ubuntu Server used in this lab type:


\begin{minted}[frame=lines,framesep=2mm]{bash}
sudo -i
\end{minted}



This lab demands installing software for that update the local package cache.


\begin{minted}[frame=lines,framesep=2mm]{bash}
apt-get update
\end{minted}

If you have time then do system upgrade
\begin{minted}[frame=lines,framesep=2mm]{bash}
apt-get dist-upgrade
\end{minted}

Install apache2 webserver and mysql database.
\begin{minted}[frame=lines,framesep=2mm]{bash}
apt-get install apache2 mysql-server ssh php5 php5-mysql 
apt-get install apache2-utils libapache2-mod-php5
\end{minted}

Download the latest version of WordPress engine.
\begin{minted}[frame=lines,framesep=2mm]{bash}
wget http://wordpress.org/latest.tar.gz
\end{minted}

Unpack dowloaded \emph{latest.tar.gz} archive to  /var/www directory using tar utility.

\begin{minted}[frame=lines,framesep=2mm]{bash}
sudo tar zxvf latest.tar.gz --directory=/var/www/
\end{minted}

Creade new mysql database called wp and database user student. Grant all privileges on database wp to user student.

\begin{minted}[frame=lines, framesep=2mm]{bash}
mysql -u root -p
create database wp;
create user student;
GRANT ALL PRIVILEGES ON wp.* TO 'student'@'localhost' IDENTIFIED BY 'student';
quit
\end{minted}

Create a new virtual host for wordpress 
\marginpar{\rule[-.9cm]{1pt}{1pt}TODO}
\begin{minted}[frame=lines,framesep=2mm]{bash}
cp /etc/apache2/sites-available/default /etc/apache2/sites-available/wp
\end{minted}

Change the owner and the group to apache2 system user/group for wordpress directories and files to ensure that web server can read and write those files.
\begin{minted}[frame=lines,framesep=2mm]{bash}
chown www-data:www-data /var/www/wordpress -R
\end{minted}

Change root directory (DocumentRoot) for new virtualhost and add server name field (ServerName) to virtualhosts configuration file   /etc/apache2/sites-available/wp


\begin{minted}[frame=lines, framesep=2mm]{bash}
ServerName	wp.planet.zz
#DocumentRoot /var/www
DocumentRoot /var/www/wordpress
\end{minted}


To enable new virtualhost for WordPress use a2ensite utility
\begin{minted}[frame=lines,framesep=2mm]{bash}
a2ensite wp
\end{minted}

Change wordpress configuration file
/var/www/wordpress/wp-config-sample.php

Set correct values for defines DB\_NAME, DB\_USER, DB\_PASSWORD as:

define('DB\_NAME', 'wp');

/** MySQL database username */

define('DB\_USER', 'student');

/** MySQL database password */

define('DB\_PASSWORD', 'student');


Copy sample configuration file to the real configuration file.
\begin{minted}[frame=lines,framesep=2mm]{bash}
cp  -a /var/www/wordpress/wp-config-sample.php /var/www/wordpress/wp-config.php
\end{minted}

Reload apache configuration files:
\begin{minted}[frame=lines,framesep=2mm]{bash}
service  apache2 reload
\end{minted}

Go to address http://wp.planet.zz/ using web browser.

Enter values for  Site Title, username, password and an e-mail

Choose Install

\subsection{Testing Your WordPress Installation against simpler DOS attacks}


How many requests default installation will serve? (parallel connections, requests/second)
Install apache2 utils on CLIENT computer, not in the server computer.

\begin{minted}[frame=lines, framesep=2mm]{bash}
sudo apt-get update
sudo apt-get install apache2-utils
\end{minted}

For Fedora/CentOS/RH/Oracle Linux install httpd-utils package.

Execute Apache Benchmark program ab
\begin{minted}[frame=lines, framesep=2mm]{bash}
ab -c<NO_CONN> -t<TIME> http://wp.planet.zz/
\end{minted}
flag c - parallel connections
flag t - time for test

\begin{minted}[frame=lines,framesep=2mm]{bash}
ab -c600 -t20 http://wp.planet.zz/
\end{minted}

In last example the ab utility makes 600 parallel connections and test takes 20 seconds.
Test results
Store test results and the command line used for tests.
Write down request per second. No of failed requests and No of completed requests.

\subsection{Hardening WordPress Installation}
After successful load generation using ab the server is extremely slow and unresponsive.

\begin{Verbatim}[samepage=true,frame=single,
label=Discussion,framesep=2mm,rulecolor=\color{blue},commandchars=\\\{\}]
Why You can not login into server?
Look at the server console. What is the OOM? What is the OOM killer?
\end{Verbatim}


If needed, reboot the server. To  guarantee log in possibility into server under attack disable swap file.

Disable swap (edit /etc/fstab file or use swapoff command)


\begin{minted}[frame=lines,framesep=2mm]{bash}
swapoff -a
\end{minted}

Disable OOM killer for MySQL database. In newer kernels write -1000 to oom\_score\_adj file.

\begin{minted}[frame=lines,framesep=2mm]{bash}
echo "-1000" > /proc/$(pidof mysqld)/oom_score_adj
\end{minted}
%$
For backward compatibility with old kernels (2.6.XX series) you can use oom\_adj file
\begin{minted}[frame=lines,framesep=2mm]{bash}
echo "-17" > /proc/$(pidof mysqld)/oom_adj
\end{minted}
%$
Documentation about proc filesystem and OOM:
\url{http://www.kernel.org/doc/Documentation/filesystems/proc.txt}

Not mandatory task: Modify mysql startup script to tune OOM score. 

WordPress Supercache
Install WordPress Supercache plugin.
Change Permalinks settings
Test cache with AB

Install Varnish HTTP cache
Change apache default port to 8080
In file /etc/apache2/ports.conf
Change 80 > 8080
Like:
NameVirtualHost *:8080
Listen 8080

Or just download new file using wget 

cd /etc/apache2
mv ports.conf /root/ports.conf.old
wget http://elab.itcollege.ee:8000/Configs/apache2/ports.conf

Change all virtual hosts to use new 8080 port using text editor or sed command.

\begin{minted}[frame=lines,framesep=2mm]{bash}
sed 's/:80>/:8080>/' -i /etc/apache2/sites-enabled/wp
\end{minted}


Install varnish and change varnish default port from 6081 to 80
apt-get install varnish
change /etc/default/varnish configuration file
Change line
\begin{minted}[frame=lines,framesep=2mm]{bash}
DAEMON_OPTS="-a *:6081 \ 
\end{minted}
to
\begin{minted}[frame=lines,framesep=2mm]{bash}
DAEMON_OPTS="-a *:80 \
\end{minted}

This means that varnish will listen port 80 on webserver

Restart apache and varnish services
\begin{minted}[frame=lines,framesep=2mm]{bash}
service apache2 restart
service varnish restart
\end{minted}
Test your result using netstat command

\begin{minted}[frame=lines, framesep=2mm]{bash}
netstat -lp | grep varnish
\end{minted}


\begin{Verbatim}[frame=single,
label=Command output,framesep=2mm,rulecolor=\color{red},commandchars=\\\{\}]
margus@marguspc:~$ 
\fbox{\color{red}varnsih}  \fbox{\color{red}TODO}
\end{Verbatim}
%$


Test new system with AB utility.

Ensure that same testing conditions and compare the results.
\begin{Verbatim}[samepage=true,frame=single,
label=Discussion,framesep=2mm,rulecolor=\color{blue},commandchars=\\\{\}]
How many requests are completed during the test?
How many requests per second the hardened WordPress installation can take?
Is it now safer? 
(You can guess that something is still wrong, and figure out what exactly)
\end{Verbatim}

Links:
\href{http://kaanon.com/blog/work/making-wordpress-shine-varnish-caching-system-part-1}{Making wordpress shine with Varnish caching system}
\href{http://kaanon.com/blog/varnish/making-wordpress-shine-varnish-caching-system-part-2}{Making wordpress shine with Varnish caching system part 2}
\href{http://www.google.com/producer/editions/CAowvZtX/full_circle_magazine_57_lite}
{Full Circle Magazine 57}

